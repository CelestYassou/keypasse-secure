<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Keypass Secure - Coffre-fort sécurisé</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root {
    --primary: #00c6ff;
    --secondary: #00ffae;
    --bg: #181c22;
    --bg-alt: #232931;
    --card: #232526;
    --text: #f5f6fa;
    --accent: #232526;
    --danger: #ff4b5c;
    --radius: 14px;
    --shadow: 0 4px 32px 0 rgba(0,0,0,0.18);
  }
  * {
    box-sizing: border-box;
  }
  #border {
    background: linear-gradient(135deg, var(--bg) 0%, var(--bg-alt) 100%);
  }
  body {
    min-height: 100vh;
    margin: 0;
    padding: 2rem;
    font-family: 'Inter', Arial, sans-serif;
    background: linear-gradient(135deg, var(--bg) 0%, var(--bg-alt) 100%);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 2px solid #000000;
  }
  h1 {
    font-size: 2.4rem;
    font-weight: 700;
    letter-spacing: 1px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 2rem;
  }
  #login, #vault {
    background: var(--card);
    box-shadow: var(--shadow);
    border-radius: var(--radius);
    padding: 2rem;
    min-width: 340px;
    max-width: 90vw;
    margin-bottom: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  input[type="password"], input[type="text"], input[type="url"] {
    background: var(--bg-alt);
    border: none;
    border-radius: var(--radius);
    padding: 0.8rem 1.1rem;
    font-size: 1rem;
    color: var(--text);
    outline: none;
    transition: box-shadow 0.2s, background 0.2s;
    box-shadow: 0 1px 6px 0 rgba(0,0,0,0.08);
  }
  input:focus {
    box-shadow: 0 0 0 2px var(--primary);
    background: #262e38;
  }
  button {
    background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
    color: var(--accent);
    border: none;
    border-radius: var(--radius);
    padding: 0.7rem 1.2rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    box-shadow: 0 1px 6px 0 rgba(0,0,0,0.08);
  }
  button:hover {
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    color: var(--text);
  }
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 300px;
    overflow-y: auto;
  }
  li {
    background: var(--bg-alt);
    margin: 0.5rem 0;
    padding: 1rem;
    border-radius: var(--radius);
    box-shadow: 0 1px 6px 0 rgba(0,0,0,0.10);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .entry-text {
    flex-grow: 1;
    word-break: break-word;
  }
  .entry-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  #vault > div.form-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  #vault > div.form-row > input, 
  #vault > div.form-row > button {
    flex: 1;
    min-width: 150px;
  }
  #urlOpenButtons {
    margin-top: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .error {
    color: var(--danger);
    font-weight: 700;
  }
  .password-row {
    display: flex;
    gap: 0.5rem;
    flex: 1;
    min-width: 150px;
  }
  .password-row input[type="password"], .password-row input[type="text"] {
    flex-grow: 1;
    margin: 0;
  }
  .password-row button {
    flex-shrink: 0;
    padding: 0 1rem;
  }
  footer {
    margin-top: auto;
    padding: 1rem 0;
    font-size: 0.9rem;
    color: #7d7d7d;
    text-align: center;
    width: 100%;
    max-width: 600px;
  }
  @media (max-width: 600px) {
    #login, #vault {
      padding: 1.2rem 0.5rem;
      min-width: unset;
    }
    h1 {
      font-size: 1.5rem;
    }
    #vault > div.form-row {
      flex-direction: column;
    }
    #vault > div.form-row > input, 
    #vault > div.form-row > button {
      flex: none;
      width: 100%;
      min-width: unset;
    }
    .password-row {
      flex-direction: column;
    }
    .password-row button {
      width: 100%;
      padding: 0.7rem 0;
    }
  }
</style>
</head>
<body>

<h1>🔐 Keypasse Secure</h1>

<div id="login">
  <input type="password" id="masterPassword" placeholder="Mot de passe maître" autocomplete="off" />
  <div style="display:flex; gap: 0.5rem; flex-wrap: wrap;">
    <button id="unlockBtn">Déverrouiller</button>
    <button id="importBtn">📥 Importer</button>
    <button id="lockBtn" style="display:none;">🔒 Verrouiller</button>
  </div>
  <p id="errorMsg" class="error" style="display:none;"></p>
  <input type="file" id="fileInput" accept="application/json" style="display:none;" />
</div>

<div id="vault" style="display:none;">
  <div class="form-row">
    <input type="text" id="site" placeholder="Nom du site" autocomplete="off" />
    <input type="url" id="url" placeholder="URL du site (https://...)" autocomplete="off" />
  </div>
  <div class="form-row password-row">
    <input type="text" id="username" placeholder="Nom d'utilisateur" autocomplete="off" />
    <input type="password" id="password" placeholder="Mot de passe" autocomplete="off" />
    <button id="generatePasswordBtn" title="Générer un mot de passe aléatoire">🔄 Générer</button>
  </div>
  <div style="display:flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
    <button id="addEntryBtn">Ajouter</button>
    <button id="saveVaultBtn">💾 Enregistrer</button>
  </div>
  <input type="text" id="search" placeholder="Rechercher..." oninput="renderEntries()" style="margin-top:1rem;" autocomplete="off" />
  <ul id="entries"></ul>
  <div id="urlOpenButtons"></div>
</div>

<footer>© 2025 Keypasse Secure - Tous droits réservés à CelestYassou - <a href="https://celestyassou.github.io/keypasse-secure/Keypasse-Secure-Politique-de-Confidentialit%C3%A9-CGU.html">Politique de Confidentialité & CGU</a></footer>

<script>
  // Variables globales
  let vaultData = [];
  let cryptoKey = null;
  let salt = null;
  const encoder = new TextEncoder();
  const decoder = new TextDecoder();

  // Elements DOM
  const masterPasswordInput = document.getElementById('masterPassword');
  const unlockBtn = document.getElementById('unlockBtn');
  const importBtn = document.getElementById('importBtn');
  const lockBtn = document.getElementById('lockBtn');
  const fileInput = document.getElementById('fileInput');
  const errorMsg = document.getElementById('errorMsg');
  const vaultDiv = document.getElementById('vault');

  const siteInput = document.getElementById('site');
  const urlInput = document.getElementById('url');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const generatePasswordBtn = document.getElementById('generatePasswordBtn');
  const addEntryBtn = document.getElementById('addEntryBtn');
  const saveVaultBtn = document.getElementById('saveVaultBtn');
  const searchInput = document.getElementById('search');
  const entriesList = document.getElementById('entries');
  const urlOpenButtonsDiv = document.getElementById('urlOpenButtons');

  // Fonction pour dériver une clé cryptographique depuis le mot de passe maître
  async function deriveKey(password, salt) {
    const keyMaterial = await window.crypto.subtle.importKey(
      'raw',
      encoder.encode(password),
      { name: 'PBKDF2' },
      false,
      ['deriveKey']
    );
    return window.crypto.subtle.deriveKey(
      {
        name: 'PBKDF2',
        salt,
        iterations: 250000,
        hash: 'SHA-256',
      },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  }

  // Fonction pour chiffrer des données JSON avec AES-GCM
  async function encryptData(data, key) {
    const iv = window.crypto.getRandomValues(new Uint8Array(12));
    const encoded = encoder.encode(JSON.stringify(data));
    const ciphertext = await window.crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      encoded
    );
    return {
      iv: arrayBufferToBase64(iv.buffer),
      data: arrayBufferToBase64(ciphertext),
    };
  }

  // Fonction pour déchiffrer les données JSON
  async function decryptData(encrypted, key) {
    const iv = base64ToArrayBuffer(encrypted.iv);
    const data = base64ToArrayBuffer(encrypted.data);
    const decrypted = await window.crypto.subtle.decrypt(
      { name: 'AES-GCM', iv },
      key,
      data
    );
    return JSON.parse(decoder.decode(decrypted));
  }

  // Utils base64
  function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    bytes.forEach((b) => (binary += String.fromCharCode(b)));
    return window.btoa(binary);
  }
  function base64ToArrayBuffer(base64) {
    const binary = window.atob(base64);
    const bytes = new Uint8Array(binary.length);
    for(let i=0; i<binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
  }

  // Affichage des messages d'erreur
  function showError(message) {
    errorMsg.style.display = 'block';
    errorMsg.textContent = message;
  }
  function clearError() {
    errorMsg.style.display = 'none';
    errorMsg.textContent = '';
  }

  // Générer mot de passe aléatoire
  function generatePassword(length = 16) {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{}|;:,.<>?';
    let pass = '';
    const array = new Uint32Array(length);
    window.crypto.getRandomValues(array);
    for (let i = 0; i < length; i++) {
      pass += chars[array[i] % chars.length];
    }
    return pass;
  }

  generatePasswordBtn.addEventListener('click', () => {
    passwordInput.value = generatePassword();
  });

  // Déverrouiller le coffre
  unlockBtn.addEventListener('click', async () => {
    clearError();
    const masterPass = masterPasswordInput.value;
    if (!masterPass) {
        showError('Veuillez entrer le mot de passe maître.');
        return;
    }
    try {
        // récupérer salt stocké ou en créer un nouveau
        let storedSalt = localStorage.getItem('kp_salt');
        if (!storedSalt) {
        salt = window.crypto.getRandomValues(new Uint8Array(16));
        localStorage.setItem('kp_salt', arrayBufferToBase64(salt));
        } else {
        salt = base64ToArrayBuffer(storedSalt);
        }
        cryptoKey = await deriveKey(masterPass, salt);

        // Tenter de récupérer coffre localement
        let storedVault = localStorage.getItem('kp_vault');
        if (storedVault) {
        // Déchiffrer coffre
        const encryptedVault = JSON.parse(storedVault);
        vaultData = await decryptData(encryptedVault, cryptoKey);
        } else {
        vaultData = [];
        }

        // Si on arrive ici, mot de passe correct, afficher coffre
        document.getElementById('login').style.display = 'none';
        vaultDiv.style.display = 'flex';
        lockBtn.style.display = 'inline-block';
        masterPasswordInput.value = '';
        renderEntries();
    } catch(e) {
        // En cas d'erreur (mauvais mdp ou déchiffrement)
        showError('Mot de passe maître incorrect ou données corrompues.');
        cryptoKey = null;
        vaultData = [];
        // S'assurer que la page coffre reste masquée
        vaultDiv.style.display = 'none';
        document.getElementById('login').style.display = 'flex';
        lockBtn.style.display = 'none';
    }
});

  // Verrouiller le coffre
  lockBtn.addEventListener('click', () => {
    vaultData = [];
    cryptoKey = null;
    siteInput.value = '';
    urlInput.value = '';
    usernameInput.value = '';
    passwordInput.value = '';
    searchInput.value = '';
    entriesList.innerHTML = '';
    urlOpenButtonsDiv.innerHTML = '';
    vaultDiv.style.display = 'none';
    document.getElementById('login').style.display = 'flex';
    lockBtn.style.display = 'none';
    clearError();
  });

  // Ajouter une entrée
  addEntryBtn.addEventListener('click', () => {
    clearError();
    const site = siteInput.value.trim();
    const url = urlInput.value.trim();
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (!site || !username || !password) {
      showError('Veuillez remplir au minimum Site, Nom d\'utilisateur et Mot de passe.');
      return;
    }
    // Vérifier URL valide si renseignée
    if (url && !/^https?:\/\/.+/.test(url)) {
      showError('URL invalide, elle doit commencer par http:// ou https://');
      return;
    }

    vaultData.push({ site, url, username, password });
    renderEntries();
    siteInput.value = '';
    urlInput.value = '';
    usernameInput.value = '';
    passwordInput.value = '';
  });

  // Modifier une entrée
  function editEntry(index) {
    const entry = vaultData[index];
    siteInput.value = entry.site;
    urlInput.value = entry.url || '';
    usernameInput.value = entry.username;
    passwordInput.value = entry.password;
    addEntryBtn.textContent = 'Modifier';
    addEntryBtn.dataset.editIndex = index;
  }

  // Confirmer modification ou ajouter nouvelle entrée
  addEntryBtn.addEventListener('click', () => {
    if (addEntryBtn.dataset.editIndex !== undefined) {
      // modification
      const index = Number(addEntryBtn.dataset.editIndex);
      vaultData[index] = {
        site: siteInput.value.trim(),
        url: urlInput.value.trim(),
        username: usernameInput.value.trim(),
        password: passwordInput.value.trim(),
      };
      addEntryBtn.textContent = 'Ajouter';
      delete addEntryBtn.dataset.editIndex;
      siteInput.value = '';
      urlInput.value = '';
      usernameInput.value = '';
      passwordInput.value = '';
      renderEntries();
    }
  });

  // Supprimer entrée
  function deleteEntry(index) {
    if (confirm('Supprimer cette entrée ?')) {
      vaultData.splice(index, 1);
      renderEntries();
    }
  }

  // Afficher les entrées filtrées
  function renderEntries() {
    const filter = searchInput.value.trim().toLowerCase();
    entriesList.innerHTML = '';
    urlOpenButtonsDiv.innerHTML = '';

    vaultData.forEach((entry, index) => {
      if (filter && !(
        entry.site.toLowerCase().includes(filter) ||
        entry.username.toLowerCase().includes(filter)
      )) return;

      const li = document.createElement('li');

      const entryText = document.createElement('div');
      entryText.className = 'entry-text';
      entryText.innerHTML =
        `<strong>${entry.site}</strong><br/>` +
        `Utilisateur: ${entry.username}<br/>` +
        `Mot de passe: <code>${entry.password}</code>`;

      li.appendChild(entryText);

      const actions = document.createElement('div');
      actions.className = 'entry-actions';

      // Bouton modifier
      const editBtn = document.createElement('button');
      editBtn.textContent = '✏️';
      editBtn.title = 'Modifier';
      editBtn.onclick = () => editEntry(index);
      actions.appendChild(editBtn);

      // Bouton supprimer
      const delBtn = document.createElement('button');
      delBtn.textContent = '🗑️';
      delBtn.title = 'Supprimer';
      delBtn.onclick = () => deleteEntry(index);
      actions.appendChild(delBtn);

      li.appendChild(actions);

      entriesList.appendChild(li);

      // Si URL, ajouter bouton ouvrir dans urlOpenButtonsDiv
      if (entry.url && /^https?:\/\/.+/.test(entry.url)) {
        const urlBtn = document.createElement('button');
        urlBtn.textContent = `🔗 ${entry.site}`;
        urlBtn.title = `Ouvrir ${entry.url}`;
        urlBtn.onclick = () => window.open(entry.url, '_blank');
        urlOpenButtonsDiv.appendChild(urlBtn);
      }
    });
  }

  // Enregistrer coffre sécurisé
  saveVaultBtn.addEventListener('click', async () => {
    clearError();
    if (!cryptoKey) {
      showError('Coffre non déverrouillé.');
      return;
    }
    try {
      const encrypted = await encryptData(vaultData, cryptoKey);
      localStorage.setItem('kp_vault', JSON.stringify(encrypted));
      alert('Coffre enregistré localement de manière sécurisée.');
    } catch(e) {
      showError('Erreur lors de l\'enregistrement : ' + e.message);
    }
  });

  // Importer coffre sécurisé
  importBtn.addEventListener('click', () => {
    fileInput.value = '';
    fileInput.click();
  });

  fileInput.addEventListener('change', async () => {
    clearError();
    if (!cryptoKey) {
      showError('Veuillez d\'abord déverrouiller le coffre avec le mot de passe maître.');
      return;
    }
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        if (!importedData.iv || !importedData.data) throw new Error('Fichier invalide');

        // Déchiffrer pour vérifier
        const decrypted = await decryptData(importedData, cryptoKey);
        if (!Array.isArray(decrypted)) throw new Error('Format de coffre invalide');

        vaultData = decrypted;
        renderEntries();
        alert('Coffre importé avec succès.');
      } catch(err) {
        showError('Erreur lors de l\'import : ' + err.message);
      }
    };
    reader.readAsText(file);
  });

</script>

</body>
</html>
